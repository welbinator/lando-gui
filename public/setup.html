<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup - Lando GUI</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .setup-container {
      max-width: 700px;
      margin: 4rem auto;
      padding: 3rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .setup-header {
      text-align: center;
      margin-bottom: 3rem;
      position: relative;
    }
    .setup-header h1 {
      margin-bottom: 0.5rem;
    }
    .close-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: none;
      border: none;
      font-size: 2rem;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      line-height: 1;
      transition: color 0.2s;
    }
    .close-btn:hover {
      color: #333;
    }
    .setup-steps {
      margin-bottom: 2rem;
    }
    .setup-step {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .setup-step h3 {
      margin-bottom: 1rem;
      color: var(--dark);
    }
    .detected {
      background: #d4edda;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      color: #155724;
    }
    .status-icon {
      display: inline-block;
      margin-right: 0.5rem;
    }
    .valid { color: var(--success); }
    .invalid { color: var(--danger); }
  </style>
</head>
<body>
  <div class="setup-container">
    <div class="setup-header">
      <button class="close-btn" onclick="window.location.href='/'" title="Close">&times;</button>
      <h1>ðŸ¦™ Welcome to Lando GUI!</h1>
      <p>Let's get you set up. We'll try to detect your settings automatically.</p>
    </div>

    <div class="setup-steps">
      <div class="setup-step">
        <h3>1. Lando Installation</h3>
        <div id="landoDetected" class="detected hidden">
          âœ… Found Lando at: <code id="detectedLandoPath"></code>
        </div>
        <div class="form-group">
          <label for="landoPath">Lando Path</label>
          <input type="text" id="landoPath" placeholder="/usr/local/bin/lando">
          <small>Leave as "lando" to use PATH, or specify full path</small>
        </div>
        <div id="landoStatus"></div>
      </div>

      <div class="setup-step">
        <h3>2. Sites Directory</h3>
        <div class="form-group">
          <label for="sitesDirectory">Sites Directory</label>
          <input type="text" id="sitesDirectory" placeholder="/home/yourname/lando or C:\Users\yourname\lando">
          <small>Where do you keep your Lando sites? This directory will be created if it doesn't exist.</small>
          <small style="display:block;margin-top:0.5rem;color:#666;">
            ðŸ’¡ <strong>Examples:</strong><br>
            â€¢ Linux/Mac: <code>/home/james/lando</code> or <code>~/lando</code><br>
            â€¢ Windows: <code>C:\Users\James\lando</code>
          </small>
        </div>
        <div id="sitesStatus"></div>
      </div>

      <div class="setup-step">
        <h3>3. WordPress Defaults (optional)</h3>
        <div class="form-group">
          <label for="wpUser">Default Admin Username</label>
          <input type="text" id="wpUser" value="admin">
        </div>
        <div class="form-group">
          <label for="wpPassword">Default Admin Password</label>
          <input type="text" id="wpPassword" value="admin">
        </div>
        <div class="form-group">
          <label for="wpEmail">Default Admin Email</label>
          <input type="email" id="wpEmail" value="admin@example.com">
        </div>
        <small>These will be used when creating new WordPress sites</small>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn btn-secondary" onclick="window.location.href='/'">Cancel</button>
      <button class="btn btn-primary" onclick="saveSetup()">Save Settings</button>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';

    async function loadCurrentConfig() {
      try {
        const response = await fetch(`${API_URL}/config`);
        const data = await response.json();

        if (data.success && data.config) {
          const { config } = data;
          
          // Load Lando path and sites directory
          document.getElementById('landoPath').value = config.landoPath || 'lando';
          document.getElementById('sitesDirectory').value = config.sitesDirectory || '';
          
          // Load WordPress defaults
          if (config.wordpress) {
            document.getElementById('wpUser').value = config.wordpress.adminUser || 'admin';
            document.getElementById('wpPassword').value = config.wordpress.adminPassword || 'admin';
            document.getElementById('wpEmail').value = config.wordpress.adminEmail || 'admin@example.com';
          }
          
          // Validate Lando path only
          await validateLandoPath();
        }
      } catch (error) {
        console.error('Failed to load config:', error);
        // Try to detect Lando path only
        await detectLandoPath();
      }
    }

    async function detectLandoPath() {
      try {
        const response = await fetch(`${API_URL}/config/detect`);
        const data = await response.json();

        if (data.success) {
          const { detected } = data;

          // Only update Lando path if field is empty
          const landoPathInput = document.getElementById('landoPath');
          if (!landoPathInput.value) {
            landoPathInput.value = detected.landoPath;
          }

          // Show validation status
          await validateLandoPath();
        }
      } catch (error) {
        console.error('Failed to detect Lando path:', error);
      }
    }

    async function validateLandoPath() {
      const landoPath = document.getElementById('landoPath').value;
      
      try {
        const response = await fetch(`${API_URL}/config/detect`);
        const data = await response.json();

        if (data.success && data.detected.landoValid) {
          document.getElementById('landoDetected').classList.remove('hidden');
          document.getElementById('detectedLandoPath').textContent = landoPath;
          document.getElementById('landoStatus').innerHTML = '<span class="valid">âœ“ Lando is working!</span>';
        } else {
          document.getElementById('landoStatus').innerHTML = '<span class="invalid">âœ— Could not verify Lando. Please check the path.</span>';
        }
      } catch (error) {
        document.getElementById('landoStatus').innerHTML = '<span class="invalid">âœ— Could not verify Lando.</span>';
      }
    }

    async function saveSetup() {
      const sitesDir = document.getElementById('sitesDirectory').value.trim();
      
      // Validate sites directory is provided
      if (!sitesDir) {
        alert('Please enter a sites directory path.');
        document.getElementById('sitesDirectory').focus();
        return;
      }

      const config = {
        landoPath: document.getElementById('landoPath').value,
        sitesDirectory: sitesDir,
        wordpress: {
          adminUser: document.getElementById('wpUser').value,
          adminPassword: document.getElementById('wpPassword').value,
          adminEmail: document.getElementById('wpEmail').value
        },
        setupComplete: true
      };

      try {
        const response = await fetch(`${API_URL}/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const data = await response.json();

        if (data.success) {
          alert('Setup complete! Redirecting to dashboard...');
          window.location.href = '/';
        } else {
          alert('Failed to save config: ' + data.error);
        }
      } catch (error) {
        alert('Failed to save config: ' + error.message);
      }
    }

    // Load current config on page load
    loadCurrentConfig();
  </script>
</body>
</html>
